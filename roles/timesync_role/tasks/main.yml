---
# Rôle : timesync_role
# Objectif : configurer la synchronisation horaire (NTP) de manière pro et dynamique

- name: Ne rien faire si timesync_role_manage est à false
  ansible.builtin.debug:
    msg: "timesync_role_manage est à false : aucune gestion NTP."
  when: not timesync_role_manage
  tags: [timesync_role, timesync]

############################################################
# 1. Déterminer le backend effectif si non défini
############################################################

- name: Déterminer le backend timesync par défaut
  ansible.builtin.set_fact:
    timesync_role_backend_effective: >-
      {{ timesync_role_backend
         if timesync_role_backend | length > 0
         else
           (
             'timesyncd'
             if ansible_service_mgr == 'systemd'
             else 'chrony'
           )
      }}
  when: timesync_role_manage
  tags: [timesync_role, timesync]

############################################################
# 2. Installer et configurer chrony
############################################################

- name: Installer chrony
  ansible.builtin.package:
    name: "{{ timesync_role_chrony_package }}"
    state: present
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'chrony'
  tags: [timesync_role, timesync, chrony]

- name: Déployer la configuration chrony.conf
  ansible.builtin.template:
    src: "chrony.conf.j2"
    dest: "{{ timesync_role_chrony_conf_file }}"
    owner: root
    group: root
    mode: "0644"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'chrony'
  notify: Restart chrony
  tags: [timesync_role, timesync, chrony]

############################################################
# 3. Installer et configurer systemd-timesyncd
############################################################

- name: Activer systemd-timesyncd (paquet et service peuvent déjà exister)
  ansible.builtin.package:
    name: "systemd-timesyncd"
    state: present
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'timesyncd'
    - ansible_os_family == "Debian"
  tags: [timesync_role, timesync, timesyncd]

- name: Déployer la configuration timesyncd.conf
  ansible.builtin.template:
    src: "timesyncd.conf.j2"
    dest: "{{ timesync_role_timesyncd_conf_file }}"
    owner: root
    group: root
    mode: "0644"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'timesyncd'
  notify: Restart systemd-timesyncd
  tags: [timesync_role, timesync, timesyncd]

############################################################
# 4. Installer et configurer ntp (optionnel, backend legacy)
############################################################

- name: Installer ntp
  ansible.builtin.package:
    name: "{{ timesync_role_ntp_package }}"
    state: present
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'ntp'
  tags: [timesync_role, timesync, ntp]

- name: Déployer la configuration ntp.conf
  ansible.builtin.template:
    src: "ntp.conf.j2"
    dest: "{{ timesync_role_ntp_conf_file }}"
    owner: root
    group: root
    mode: "0644"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'ntp'
  notify: Restart ntp
  tags: [timesync_role, timesync, ntp]

############################################################
# 5. S'assurer que le service choisi est activé et démarré
############################################################

- name: Activer et démarrer chrony
  ansible.builtin.service:
    name: "{{ timesync_role_chrony_service }}"
    enabled: "{{ timesync_role_enable_service }}"
    state: "{{ 'started' if timesync_role_ensure_running else 'stopped' }}"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'chrony'
  tags: [timesync_role, timesync, chrony]

- name: Activer et démarrer systemd-timesyncd
  ansible.builtin.service:
    name: "{{ timesync_role_timesyncd_service }}"
    enabled: "{{ timesync_role_enable_service }}"
    state: "{{ 'started' if timesync_role_ensure_running else 'stopped' }}"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'timesyncd'
  tags: [timesync_role, timesync, timesyncd]

- name: Activer et démarrer ntp
  ansible.builtin.service:
    name: "{{ timesync_role_ntp_service }}"
    enabled: "{{ timesync_role_enable_service }}"
    state: "{{ 'started' if timesync_role_ensure_running else 'stopped' }}"
  when:
    - timesync_role_manage
    - timesync_role_backend_effective == 'ntp'
  tags: [timesync_role, timesync, ntp]