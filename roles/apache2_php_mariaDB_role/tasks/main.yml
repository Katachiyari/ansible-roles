---
# Rôle : apache2_php_mariaDB_role
# Objectif : installer Apache2 + PHP + MariaDB et déployer une app PHP connectée à MariaDB

# 1. Installation Apache2 (Debian)
- name: Installer Apache2 (Debian/Ubuntu)
  ansible.builtin.apt:
    name: apache2
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

# 2. Installation PHP (Debian)
- name: Installer PHP et modules nécessaires (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ apache2_php_mariadb_php_packages }}"
    state: present
  when: ansible_os_family == "Debian"

# 3. Installation MariaDB (optionnelle)
- name: Installer MariaDB (serveur + client) (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ apache2_php_mariadb_packages }}"
    state: present
  when:
    - ansible_os_family == "Debian"
    - apache2_php_mariadb_install_server

- name: Installer seulement le client MariaDB (Debian/Ubuntu)
  ansible.builtin.apt:
    name: mariadb-client
    state: present
  when:
    - ansible_os_family == "Debian"
    - not apache2_php_mariadb_install_server

# 4. S'assurer qu'Apache est démarré et activé
- name: S'assurer qu'Apache2 est démarré et activé
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: true
  when: ansible_os_family == "Debian"

# 5. S'assurer que MariaDB est démarré et activé (si serveur)
- name: S'assurer que MariaDB est démarré et activé
  ansible.builtin.service:
    name: mariadb
    state: started
    enabled: true
  when:
    - ansible_os_family == "Debian"
    - apache2_php_mariadb_install_server

# 6. Créer la base de données et l'utilisateur (si serveur)
- name: Créer la base de données MariaDB
  community.mysql.mysql_db:
    name: "{{ apache2_php_mariadb_db_name }}"
    state: present
  when:
    - apache2_php_mariadb_install_server

- name: Créer l'utilisateur MariaDB
  community.mysql.mysql_user:
    name: "{{ apache2_php_mariadb_db_user }}"
    password: "{{ apache2_php_mariadb_db_password }}"
    priv: "{{ apache2_php_mariadb_db_name }}.*:ALL"
    host: "%"
    state: present
  when:
    - apache2_php_mariadb_install_server

# 7. Créer le document root pour l'app PHP
- name: Créer le document root de l'application PHP
  ansible.builtin.file:
    path: "{{ apache2_php_mariadb_document_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"

# 8. Déployer une app PHP d'exemple (index.php)
- name: Déployer une app PHP d'exemple
  ansible.builtin.template:
    src: "index.php.j2"
    dest: "{{ apache2_php_mariadb_document_root }}/index.php"
    owner: www-data
    group: www-data
    mode: "0644"
  when: apache2_php_mariadb_deploy_example_app

# 9. Déployer le vhost Apache pour l'app PHP
- name: Déployer le vhost Apache pour l'app PHP (Debian)
  ansible.builtin.template:
    src: "php_app_vhost.conf.j2"
    dest: "/etc/apache2/sites-available/{{ apache2_php_mariadb_server_name }}.conf"
    owner: root
    group: root
    mode: "0644"
  when: ansible_os_family == "Debian"

- name: Activer le vhost Apache
  ansible.builtin.file:
    src: "/etc/apache2/sites-available/{{ apache2_php_mariadb_server_name }}.conf"
    dest: "/etc/apache2/sites-enabled/{{ apache2_php_mariadb_server_name }}.conf"
    state: link
  when: ansible_os_family == "Debian"

# 10. Désactiver le site par défaut (optionnel, ici on le fait)
- name: Désactiver le site par défaut (000-default.conf)
  ansible.builtin.file:
    path: /etc/apache2/sites-enabled/000-default.conf
    state: absent
  when: ansible_os_family == "Debian"

# 11. Recharger Apache
- name: Recharger Apache2
  ansible.builtin.service:
    name: apache2
    state: reloaded
  when: ansible_os_family == "Debian"
  