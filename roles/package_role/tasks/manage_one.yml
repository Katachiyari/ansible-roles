---
# manage_one.yml
# Gérer un item de package_role_items : package_item

# 1. Déterminer le state final (avec défaut)
- name: Calculer le state pour {{ package_item.name }}
  ansible.builtin.set_fact:
    package_role_effective_state: "{{ package_item.state | default('present') }}"

# 2. Si un manager est forcé, utiliser celui-ci
- name: Gérer le paquet avec le manager forcé (apt)
  ansible.builtin.apt:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    update_cache: "{{ package_item.update_cache | default(false) }}"
  when:
    - package_item.manager | default('') == 'apt'
    - ansible_os_family == "Debian"

- name: Gérer le paquet avec le manager forcé (yum)
  ansible.builtin.yum:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    enablerepo: "{{ package_item.enablerepo | default(omit) }}"
    disablerepo: "{{ package_item.disablerepo | default(omit) }}"
    allow_downgrade: "{{ package_item.allow_downgrade | default(omit) }}"
  when:
    - package_item.manager | default('') == 'yum'
    - ansible_os_family == "RedHat"

- name: Gérer le paquet avec le manager forcé (dnf)
  ansible.builtin.dnf:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    enablerepo: "{{ package_item.enablerepo | default(omit) }}"
    disablerepo: "{{ package_item.disablerepo | default(omit) }}"
    allow_downgrade: "{{ package_item.allow_downgrade | default(omit) }}"
  when:
    - package_item.manager | default('') == 'dnf'
    - ansible_os_family == "RedHat"

- name: Gérer le paquet avec le manager forcé (zypper)
  ansible.builtin.zypper:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    update_cache: "{{ package_item.update_cache | default(false) }}"
  when:
    - package_item.manager | default('') == 'zypper'
    - ansible_os_family == "Suse"

- name: Gérer le paquet avec le manager forcé (package générique)
  ansible.builtin.package:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    use: "{{ package_item.use_backend | default(omit) }}"
  when:
    - package_item.manager | default('') == 'package'

# 3. Si aucun manager n'est forcé, choisir automatiquement en fonction de l'OS
- name: Gérer le paquet (auto - apt pour Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    update_cache: "{{ package_item.update_cache | default(false) }}"
  when:
    - package_item.manager is not defined
    - ansible_os_family == "Debian"

- name: Gérer le paquet (auto - yum/dnf pour RedHat)
  ansible.builtin.yum:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    enablerepo: "{{ package_item.enablerepo | default(omit) }}"
    disablerepo: "{{ package_item.disablerepo | default(omit) }}"
    allow_downgrade: "{{ package_item.allow_downgrade | default(omit) }}"
  when:
    - package_item.manager is not defined
    - ansible_os_family == "RedHat"

- name: Gérer le paquet (auto - zypper pour Suse)
  ansible.builtin.zypper:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
    update_cache: "{{ package_item.update_cache | default(false) }}"
  when:
    - package_item.manager is not defined
    - ansible_os_family == "Suse"

# 4. Fallback générique si rien n'a matché
- name: Gérer le paquet (fallback - module package générique)
  ansible.builtin.package:
    name: "{{ package_item.name }}"
    state: "{{ package_role_effective_state }}"
  when:
    - package_item.manager is not defined
    - ansible_os_family not in ["Debian", "RedHat", "Suse"]