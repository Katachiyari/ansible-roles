---
# Rôle : sys_upgrade_role
# Objectif : mise à jour des systèmes Linux (multi-OS) de façon contrôlée

- name: Ne rien faire si sys_upgrade_role_manage est à false
  ansible.builtin.debug:
    msg: "sys_upgrade_role_manage est à false : aucune mise à jour système exécutée."
  when: not sys_upgrade_role_manage
  tags: [sys_upgrade_role, sysupgrade]

############################################################
# 1. Mises à jour sur Debian/Ubuntu
############################################################

- name: Mettre à jour le cache APT
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when:
    - sys_upgrade_role_manage
    - sys_upgrade_role_update_cache
    - ansible_os_family == "Debian"
  tags: [sys_upgrade_role, sysupgrade, apt]

- name: Mise à niveau des paquets APT (safe upgrade)
  ansible.builtin.apt:
    upgrade: "yes"
  when:
    - sys_upgrade_role_manage
    - ansible_os_family == "Debian"
    - sys_upgrade_role_upgrade_type == "safe"
  tags: [sys_upgrade_role, sysupgrade, apt]

- name: Mise à niveau complète des paquets APT (full-upgrade)
  ansible.builtin.apt:
    upgrade: "full"
  when:
    - sys_upgrade_role_manage
    - ansible_os_family == "Debian"
    - sys_upgrade_role_upgrade_type == "full"
  tags: [sys_upgrade_role, sysupgrade, apt]

############################################################
# 2. Mises à jour sur RedHat/CentOS/Rocky/Alma
############################################################

- name: Mettre à jour le cache YUM/DNF
  ansible.builtin.yum:
    name: "*"
    state: latest
    update_only: true
  when:
    - sys_upgrade_role_manage
    - sys_upgrade_role_update_cache
    - ansible_os_family == "RedHat"
  tags: [sys_upgrade_role, sysupgrade, yum]

- name: Mise à jour complète des paquets YUM/DNF
  ansible.builtin.yum:
    name: "*"
    state: latest
  when:
    - sys_upgrade_role_manage
    - ansible_os_family == "RedHat"
    - sys_upgrade_role_full_upgrade_redhat
  tags: [sys_upgrade_role, sysupgrade, yum]

############################################################
# 3. Mises à jour sur Suse (zypper)
############################################################

- name: Rafraîchir les dépôts zypper
  ansible.builtin.zypper:
    name: "*"
    state: latest
    update_cache: "{{ sys_upgrade_role_update_cache }}"
  when:
    - sys_upgrade_role_manage
    - ansible_os_family == "Suse"
    - sys_upgrade_role_full_upgrade_suse
  tags: [sys_upgrade_role, sysupgrade, zypper]

############################################################
# 4. Détection besoin de reboot (Debian/Ubuntu)
############################################################

- name: Vérifier si un reboot est nécessaire (Debian/Ubuntu)
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: sys_upgrade_reboot_required
  when:
    - sys_upgrade_role_manage
    - ansible_os_family == "Debian"
  tags: [sys_upgrade_role, sysupgrade, reboot]

############################################################
# 5. Reboot automatique optionnel
############################################################

- name: Redémarrer la machine si nécessaire (Debian/Ubuntu)
  ansible.builtin.reboot:
    msg: "{{ sys_upgrade_role_reboot_msg }}"
    reboot_timeout: "{{ sys_upgrade_role_reboot_timeout }}"
  when:
    - sys_upgrade_role_manage
    - sys_upgrade_role_auto_reboot
    - ansible_os_family == "Debian"
    - sys_upgrade_reboot_required.stat.exists | default(false)
  tags: [sys_upgrade_role, sysupgrade, reboot]