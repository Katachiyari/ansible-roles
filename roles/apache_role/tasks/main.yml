---
# Rôle : apache
# Objectif : installer Apache et gérer des vhosts dynamiques

- name: Installer Apache (Debian/Ubuntu)
  ansible.builtin.apt:
    name: apache2
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Installer Apache (RedHat/CentOS)
  ansible.builtin.yum:
    name: httpd
    state: present
  when: ansible_os_family == "RedHat"

- name: S'assurer qu'Apache est démarré et activé (Debian)
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: true
  when: ansible_os_family == "Debian"

- name: S'assurer qu'Apache est démarré et activé (RedHat)
  ansible.builtin.service:
    name: httpd
    state: started
    enabled: true
  when: ansible_os_family == "RedHat"

# Optionnel : désactiver le site par défaut si tu ne veux que tes vhosts
- name: Désactiver le site par défaut (Debian)
  ansible.builtin.file:
    path: /etc/apache2/sites-enabled/000-default.conf
    state: absent
  when:
    - ansible_os_family == "Debian"
    - not apache_enable_default_site

# Créer les répertoires pour chaque vhost
- name: Créer les document roots pour les vhosts
  ansible.builtin.file:
    path: "{{ item.document_root }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
  loop: "{{ apache_vhosts }}"
  loop_control:
    label: "{{ item.document_root }}"
  when: apache_vhosts | length > 0

# Déployer les fichiers de vhost (Debian)
- name: Déployer les vhosts (Debian)
  ansible.builtin.template:
    src: vhost.conf.j2
    dest: "/etc/apache2/sites-available/{{ item.server_name }}.conf"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ apache_vhosts }}"
  loop_control:
    label: "{{ item.server_name }}"
  when:
    - ansible_os_family == "Debian"
    - apache_vhosts | length > 0

- name: Activer les vhosts (Debian)
  ansible.builtin.file:
    src: "/etc/apache2/sites-available/{{ item.server_name }}.conf"
    dest: "/etc/apache2/sites-enabled/{{ item.server_name }}.conf"
    state: link
  loop: "{{ apache_vhosts }}"
  loop_control:
    label: "{{ item.server_name }}"
  when:
    - ansible_os_family == "Debian"
    - apache_vhosts | length > 0

- name: Recharger Apache après modification des vhosts (Debian)
  ansible.builtin.service:
    name: apache2
    state: reloaded
  when:
    - ansible_os_family == "Debian"
    - apache_vhosts | length > 0